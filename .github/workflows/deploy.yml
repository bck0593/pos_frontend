# 置き換え対象ステップ：Deploy via Kudu ZIP Deploy (async + poll)
- name: Deploy via Kudu ZIP Deploy (async + poll)
  env:
    PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
  run: |
    set -euo pipefail

    # 発行プロファイル(XML)から「ZipDeploy」のブロックだけを厳密に抜く
    sudo apt-get update >/dev/null 2>&1
    sudo apt-get install -y libxml2-utils >/dev/null 2>&1

    ZIP_USER=$(xmllint --xpath 'string(//publishProfile[@publishMethod="ZipDeploy"]/@userName)'    <<< "$PUBLISH_PROFILE" || true)
    ZIP_PASS=$(xmllint --xpath 'string(//publishProfile[@publishMethod="ZipDeploy"]/@userPWD)'     <<< "$PUBLISH_PROFILE" || true)
    ZIP_URL=$(xmllint  --xpath 'string(//publishProfile[@publishMethod="ZipDeploy"]/@publishUrl)'  <<< "$PUBLISH_PROFILE" || true)

    if [ -z "${ZIP_USER:-}" ] || [ -z "${ZIP_PASS:-}" ] || [ -z "${ZIP_URL:-}" ]; then
      echo "::error ::ZipDeploy profile not found in publish profile XML"
      echo "$PUBLISH_PROFILE" | sed -n '1,30p'
      exit 1
    fi

    # 例: publishUrl = app-xxxx-yyy.scm.azurewebsites.net:443
    BASE="https://${ZIP_URL%:*}"   # 末尾の :443 を除去
    echo "Zipdeploy endpoint: $BASE"

    echo "Uploading site.zip (async)..."
    curl -fSs -u "$ZIP_USER:$ZIP_PASS" \
      -X POST "$BASE/api/zipdeploy?isAsync=true" \
      -H "Content-Type: application/zip" \
      --data-binary @site.zip

    echo "Polling deployment status..."
    for i in $(seq 1 80); do
      INFO=$(curl -sS -u "$ZIP_USER:$ZIP_PASS" "$BASE/api/deployments/latest" || true)
      STATUS=$(echo "$INFO" | jq -r '.status // empty')
      TEXT=$(echo "$INFO" | jq -r '.statusText // empty')
      echo "[$i] status=${STATUS:-n/a} ${TEXT:-}"
      if [ "$STATUS" = "4" ]; then
        echo "Deployment finished (SUCCESS)."
        break
      fi
      if [ "$STATUS" = "3" ]; then
        echo "::error ::Kudu deployment failed"
        echo "$INFO"
        exit 1
      fi
      sleep 3
    done
