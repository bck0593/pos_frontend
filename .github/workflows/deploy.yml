# .github/workflows/deploy.yml
name: Deploy Frontend to Azure Web App

on:
  push:
    branches: [ "main" ]
    paths:
      - ".github/workflows/deploy.yml"
      - "frontend/**"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # すべて frontend/ で実行（これが超重要）
    defaults:
      run:
        working-directory: frontend

    env:
      AZURE_WEBAPP_NAME: app-002-gen10-step3-1-node-oshima29
      NEXT_TELEMETRY_DISABLED: "1"
      NEXT_DISABLE_ESLINT_PLUGIN: "true"

      # ===== ビルド時にクライアントへ埋め込む =====
      NEXT_PUBLIC_BACKEND_URL: https://app-002-gen10-step3-1-py-oshima29.azurewebsites.net
      NEXT_PUBLIC_API_BASE: https://app-002-gen10-step3-1-py-oshima29.azurewebsites.net
      NEXT_PUBLIC_API_BASE_URL: https://app-002-gen10-step3-1-py-oshima29.azurewebsites.net

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Ensure Next standalone output is enabled
        run: |
          node -e "const fs=require('fs');const p='./next.config.js';let t=fs.existsSync(p)?fs.readFileSync(p,'utf8'):'module.exports={};';if(!/output:\s*['\"]standalone['\"]/.test(t)){t=t.replace(/module\.exports\s*=\s*{?/, m=>m.includes('{')?m:m+'{') ; t=t.replace(/}\s*;?\s*$/, ', output:\"standalone\" }'); fs.writeFileSync(p,t); console.log('patched next.config.js to enable standalone');} else {console.log('standalone already enabled');}"

      - name: Install & Build
        run: |
          npm ci
          npm run build --no-lint
          echo "=== list .next ==="; ls -la .next || true
          echo "=== list .next/standalone ==="; ls -la .next/standalone || true
          echo "=== sanity check: backend URL embedded ==="
          (grep -R "app-002-gen10-step3-1-py-oshima29" -n .next || (echo "::error ::Backend URL not found in client bundle"; exit 1))

      - name: Prepare artifact
        run: |
          rm -rf ../out && mkdir -p ../out/.next
          # サーバ（standalone）一式
          cp -r .next/standalone/* ../out/
          # 静的資産
          cp -r .next/static ../out/.next/static
          # public があれば同梱
          if [ -d public ]; then cp -r public ../out/public; fi
          # 起動スクリプト（Azure Linux は npm start を探す）
          node -e "const fs=require('fs');const pkg=JSON.parse(fs.readFileSync('package.json','utf8'));pkg.scripts=pkg.scripts||{};pkg.scripts.start='node server.js';fs.writeFileSync('../out/package.json',JSON.stringify(pkg,null,2));"

      - name: Sleep (avoid SCM race)
        run: sleep 10

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./out
